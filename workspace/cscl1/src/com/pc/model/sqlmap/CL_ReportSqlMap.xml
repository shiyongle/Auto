<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CL_Report">
	<!-- 客户账单报表明细查询条件 -->
	<sql id="findWhere1">
	    <where>
	        <if test="true">
			<!-- 月账单明细,这里过滤条件得确认，订单有司机承运user_role_id字段应该不为空？ -->
			    AND co.status > 3 AND co.status &lt;> 6 AND co.user_role_id IS NOT NULL
			</if>
			<if test="@Ognl@isNotEmpty(fuserid)">
			    AND co.creator = #{fuserid}
			</if>
		   	<if test="@Ognl@isNotEmpty(fcustomerid)">
			    AND uc.fid = #{fcustomerid}
			</if>
		   	<if test="@Ognl@isNotEmpty(fsalesmandept)">
		   		AND uc.fsales_man_dept = #{fsalesmandept}
		   	</if>
			<if test="@Ognl@isNotEmpty(fregion)">
			    AND uc.fregion LIKE CONCAT('%',#{fregion},'%')
			</if>
			<if test="@Ognl@isNotEmpty(fdriverName)">
			    AND cc.driverName LIKE CONCAT('%',#{fdriverName},'%')
			</if>
		   	<if test="@Ognl@isNotEmpty(fcarid)">
			    AND cc.id = #{fcarid}
			</if>
			<if test="@Ognl@isNotEmpty(fsaleman)">
		   		AND uc.fsales_man LIKE CONCAT('%',#{fsaleman},'%')
		   	</if>
	   		<if test="@Ognl@isNotEmpty(fstarttime)">
		   		AND co.create_time >= #{fstarttime}
		   	</if>
			<if test="@Ognl@isNotEmpty(fendtime)">
		   		AND co.create_time &lt;= #{fendtime}
		   	</if>
		   	<if test="@Ognl@isNotEmpty(fmonth)">
		   		AND LEFT(co.create_time,7) = #{fmonth}
		   	</if>	   	
		   	
	    </where>
	</sql>
	
	<!-- 客户账单月报表查询条件 -->
    <sql id="findWhere2">
	    <where>
	    	<if test="true">
			    AND co.status > 3 AND co.status &lt;> 6
			</if>
		   	<if test="@Ognl@isNotEmpty(fstartMonth)">
				 <if test="@Ognl@isNotEmpty(fendMonth)">
				    AND LEFT(co.create_time,7) between #{fstartMonth} and #{fendMonth}
				</if> 
			</if>  	
	    </where>
	</sql>
	
	<!-- （新客户月账单查询条件） -->
    <sql id="findWhere3">
	    <where>
	    	<if test="true">
<!-- fpay_type = 5  表示月结； roleid = 1表示货主;在线支付不在账单统计范围内 -->
			    AND fs.fpay_type = 5 AND ur.role_id = 1
			</if>
			<if test="@Ognl@isNotEmpty(fuserid)">
			    AND fs.fuserrole_id = #{fuserid}
			</if>
		   	<if test="@Ognl@isNotEmpty(fstartMonth)">
				 <if test="@Ognl@isNotEmpty(fendMonth)">
				    AND LEFT(fs.fcreate_time,7) between #{fstartMonth} and #{fendMonth}
				</if> 
			</if>  	
	    </where>
	</sql>
	
		<!-- 司机运费报表 -->
	<sql id="findWhere4">
	    <where>
	        <if test="true">
			<!-- 用户角色是司机 -->
			    AND ur.role_id = 2 
			</if>
			<if test="@Ognl@isNotEmpty(fuserid)">
			    AND ur.id = #{fuserid}
			</if>		   
	   		<if test="@Ognl@isNotEmpty(fstarttime)">
		   		AND fs.fcreate_time >= #{fstarttime}
		   	</if>
			<if test="@Ognl@isNotEmpty(fendtime)">
		   		AND fs.fcreate_time &lt;= #{fendtime}
		   	</if>  			   	
	    </where>
	</sql>
	
	<!-- 客户账单月报表查询条件 -->
	
    <!--
    	分页查询已经使用Dialect进行分页,也可以不使用Dialect直接编写分页
    	因为分页查询将传 #offset#,#pageSize#,#lastRows# 三个参数,不同的数据库可以根于此三个参数属性应用不同的分页实现
    -->
        
	<!--用户账单明细报表 -->
							<!-- java.lang.String -->
    <select id="findRptPage" resultType="java.util.Map">
        <!-- coid：订单号，couserid：货主,fcaruserid:抢单司机      以上字段用户取收支明细表取数用-->
    	SELECT co.id coid,co.creator couserid,DATE_FORMAT(co.create_time,'%Y-%m-%d') createTime,co.coupons_detail_id cpdid,
    	 ur.vmi_user_name custName,co.number orderNumber,uc.fsales_man saleMan,uc.fsales_man_dept saleMandept,
    	uc.fregion region,cc.user_role_id fcaruserid,cc.carNum,co.freight,co.fdriverfee,co.fpay_Method payMethod,co.fremark,cc.driverName 
 		FROM cl_order co LEFT JOIN cl_car cc ON cc.user_role_id = co.user_role_id 
 		LEFT JOIN cl_user_role ur ON ur.id = co.creator
		LEFT JOIN cl_user_customer uc ON co.creator = uc.fuser_role_id				
		<include refid="findWhere1"/>
		<if test="@Ognl@isNotEmpty(sortColumns)">
			ORDER BY co.create_time desc
		</if>
    </select>
    
    <!--老客户月账单表头报表 -->
    <select id="findRptMonthPage" resultType="java.util.Map">
        SELECT LEFT(co.create_time,7) fmonth,SUM(co.freight) freight FROM cl_order co 
		<include refid="findWhere2"/>
		GROUP BY LEFT(co.create_time,7)		
    </select>
    
    <!--(新)货主月账单报表 -->
    <select id="loadUserBillReport" resultType="java.util.Map">
        SELECT  ur.id fuserId,LEFT(fs.fcreate_time,7) fmonth,ur.vmi_user_name fuserName,SUM(-ftype*famount) fsumPay 
		FROM cl_finance_statement fs LEFT JOIN cl_user_role ur ON ur.id = fs.fuserrole_id 
		<include refid="findWhere3"/>
		 GROUP BY ur.id,LEFT(fs.fcreate_time,7)	
    </select>
   
    <!--司机运费报表 -->
    <select id="findDriverFreightPage" resultType="java.util.Map">
		SELECT DATE_FORMAT(fs.fcreate_time,'%Y-%m-%d %H:%i') fcreateTime,cc.driverName fdriver,cc.carNum fcarNum,
		fs.ftype*fs.famount freight,fs.fbusiness_type fbusinessType 
		FROM cl_finance_statement fs 
		LEFT JOIN cl_user_role ur ON ur.id = fs.fuserrole_id 
		LEFT JOIN cl_car cc ON cc.user_role_id = ur.id
		<include refid="findWhere4"/>
    </select>
	
</mapper>

