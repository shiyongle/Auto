<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CL_FinanceBill">

    <resultMap id="CL_FinanceBillMap" type="com.pc.model.CL_FinanceBill">
        <result property="fid" column="fid"/>
        <result property="fbillDate" column="fbillDate"/>
        <result property="fcustId" column="fcustId"/>
        <result property="fcustName" column="fcustName"/>
        <result property="fbillAmount" column="fbillAmount"/>
        <result property="funPayAmount" column="funPayAmount"/>
        <result property="fverification" column="fverification"/>
    </resultMap>

	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
	    <![CDATA[
	    *
	    ]]>
	</sql>
	 <insert id="insert" >
    <![CDATA[
        INSERT INTO cl_finance_bill (	
			fid,	
			fbillDate,	
			fcustId,	
			fcustName,	
			fbillAmount,	
			funPayAmount,	
			fverification	
        ) VALUES (
        	#{fid, jdbcType=INTEGER} ,
        	#{fbillDate, jdbcType=TIMESTAMP} ,
        	#{fcustId, jdbcType=INTEGER} ,
        	#{fcustName, jdbcType=VARCHAR} ,
        	#{fbillAmount, jdbcType=DECIMAL} ,
        	#{funPayAmount, jdbcType=DECIMAL} ,
        	#{fverification, jdbcType=BIT}
        )
    ]]>
    </insert>

    <update id="update" >
    <![CDATA[
    	UPDATE cl_finance_bill SET
			fid=#{fid,jdbcType=INTEGER},
			fbillDate=#{fbillDate,jdbcType=TIMESTAMP},
			fcustId=#{fcustId,jdbcType=INTEGER},
			fcustName=#{fcustName,jdbcType=VARCHAR},
			fbillAmount=#{fbillAmount,jdbcType=DECIMAL},
			funPayAmount=#{funPayAmount,jdbcType=DECIMAL},
			fverification=#{fverification,jdbcType=BIT}
        WHERE 
	        fid = #{fid} 
    ]]>
    </update>

    <delete id="delete">
    <![CDATA[
        DELETE FROM cl_finance_bill WHERE
        fid = #{fid} 
    ]]>
    </delete>
    
    <select id="getById" resultMap="CL_FinanceBillMap">
	    SELECT <include refid="columns"/>
	    <![CDATA[
	        FROM cl_finance_bill WHERE fid = #{id} 
	    ]]>
    </select>

	<sql id="findWhere">
	    <where>
		   	<if test="@Ognl@isNotEmpty(fcustId)">
			    AND fcustId =#{fcustId}
			</if>
		   	<if test="@Ognl@isNotEmpty(fverification)">
			    AND fverification =#{fverification}
			</if>
		   	<if test="@Ognl@isNotEmpty(fstartMonth)">
				 <if test="@Ognl@isNotEmpty(fendMonth)">
				    AND LEFT(fbillDate,7) between #{fstartMonth} and #{fendMonth}
				</if> 
			</if>  
	    </where>
	</sql>
	 
    <select id="findAllPage" resultMap="CL_FinanceBillMap">
    	SELECT <include refid="columns"/> FROM cl_finance_bill 
		<include refid="findWhere"/>
		order by fbillDate
    </select>
    
    
     <select id="findPageCount" resultType="long">
        SELECT count(*) FROM cl_finance_bill
        <include refid="findWhere"/>    
    </select>
    
    <select id="findPage" resultMap="CL_FinanceBillMap">
    	SELECT <include refid="columns"/> FROM cl_finance_bill
		<include refid="findWhere"/>
		<if test="@Ognl@isNotEmpty(sortColumns)">
			ORDER BY ${sortColumns}
		</if>
    </select>
    
    <select id="find" resultMap="CL_FinanceBillMap">
	    SELECT <include refid="columns"/> 
	    FROM cl_finance_bill
		<include refid="findWhere"/>
		<if test="@Ognl@isNotEmpty(sortColumns)">
			ORDER BY ${sortColumns}
		</if>
    </select>
	
	    
    <!--每月1号0点定时执行生成账单;账单为0也要生成,所以加了一个OR fs.fcreate_time IS NULL-->
    <select id="getLastMonthBill" resultType="java.util.Map">
	    SELECT ur.id fcustId, IF(fs.fcreate_time IS NULL,DATE_SUB(CURDATE(), INTERVAL 1 MONTH),fs.fcreate_time) fbillDate,
	    ur.vmi_user_name fcustName,IFNULL(SUM(- ftype * famount),0)  fbillAmount  FROM  cl_user_role ur 
	    LEFT JOIN cl_finance_statement fs ON ur.id = fs.fuserrole_id
	    WHERE ur.role_id = 1 AND ur.is_protocol = 1 AND ( (fs.fpay_type = 5 
	    AND LEFT(fs.fcreate_time,7) = DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 MONTH),'%Y-%m') )
        OR fs.fcreate_time IS NULL ) GROUP BY ur.id,LEFT(fs.fcreate_time, 7)
    </select>
    
    <!-- 查询用户月账单 -->
	<select id="CusBillfindPage" resultMap="CL_FinanceBillMap">
		select ur.id as fcustId,ur.vmi_user_name as fcustName,date_format(cf.fcreate_time,'%Y-%m-%d') as fbillDate,
		sum(cf.famount) as fbillAmount from cl_finance_statement cf 
		left join cl_user_role ur on ur.id = cf.fuserrole_id
		<include refid="findWhere0"/>
		group by cf.fuserrole_id
	</select>
	
	<select id="CusBillfindPageCount" resultType="long">
		select count(a.fcustId) from (select ur.id as fcustId,ur.vmi_user_name as fcustName,date_format(cf.fcreate_time,'%Y-%m-%d') as fbillDate,
		sum(cf.famount) as fbillAmount from cl_finance_statement cf 
		left join cl_user_role ur on ur.id = cf.fuserrole_id
		<include refid="findWhere0"/>
		group by cf.fuserrole_id)a
	</select>
	<sql id="findWhere0">
	    <where>
		   	<if test="@Ognl@isNotEmpty(fcustId)">
			    AND cf.fuserrole_id =#{fcustId}
			</if>
		   	<if test="@Ognl@isNotEmpty(fverification)">
			    AND fverification =#{fverification}
			</if>
		   	<if test="@Ognl@isNotEmpty(fstartMonth)">
				 <if test="@Ognl@isNotEmpty(fendMonth)">
				    and left(date_format(cf.fcreate_time,'%Y-%m'),7) between #{fstartMonth} and #{fendMonth}
				</if> 
			</if> 
			and cf.fpay_type = 5 and fstatus = 1 
	    </where>
	 </sql>
</mapper>

