<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="CL_CouponsActivity">
    	<resultMap type="com.pc.model.CL_CouponsActivity" id="CL_CouponsActivityMap">
    		<result property="fid" column="fid"/>
    		<result property="fbusinessType" column="fbusiness_type"/>
    		<result property="fcouponsId" column="fcoupons_id"/>
    		<result property="feffective" column="feffective"/>
    		<result property="factivityStartTime" column="factivity_start_time"/>
    		<result property="factivityEndTime" column="factivity_end_time"/>
    		<result property="fissueUser" column="fissue_user"/>
    		<result property="fexcelName" column="fexcel_name"/>
    		<result property="fgetType" column="fget_type"/>
    		<result property="fuseStartTime" column="fuse_start_time"/>
    		<result property="fuseEndTime" column="fuse_end_time"/>
    		<result property="fuseTime" column="fuse_time"/>
    		<result property="fdollars" column="fdollars"/>
    		<result property="fcarSpecId" column="fcar_spec_id"/>
    		<result property="farea" column="farea"/>
    		<result property="createTime" column="create_time"/>
    		<result property="creator" column="creator"/>
    		<result property="operateTime" column="operate_time"/>
    		<result property="operator" column="operator"/>
    	</resultMap>
    	
    	<sql id="columns">
    		ca.fid,ca.fbusiness_type,ca.fcoupons_id,ca.feffective,ca.factivity_start_time,ca.factivity_end_time,ca.fissue_user,ca.fget_type,ca.fuse_start_time,ca.fuse_end_time,ca.fuse_time,ca.fdollars,ca.fcar_spec_id,ca.farea,ca.create_time,ca.creator,ca.operate_time,ca.operator,
    		cc.fcoupons_name fcouponsName,cc.fbusiness_type fbusinessType,cc.fdiscount,cc.fsubtract,cc.faddservice_name faddserviceName,cc.ftype fcouponsType,ca.fexcel_name
    	</sql>
    	
    	<insert id="insert">
    		insert into cl_couponsActivity(
    			fid,
    			fbusiness_type,
    			fcoupons_id,
    			feffective,
    			factivity_start_time,
    			factivity_end_time,
    			fissue_user,
    			fexcel_name,
    			fget_type,
    			fuse_start_time,
    			fuse_end_time,
    			fuse_time,
    			fdollars,
    			fcar_spec_id,
    			farea,
    			create_time,
    			creator,
    			operate_time,
    			operator
    		) values(
    			#{fid,jdbcType=INTEGER},
    			#{fbusinessType,jdbcType=VARCHAR},
    			#{fcouponsId,jdbcType=INTEGER},
    			#{feffective,jdbcType=INTEGER},
    			#{factivityStartTime,jdbcType=TIMESTAMP},
    			#{factivityEndTime,jdbcType=TIMESTAMP},
    			#{fissueUser,jdbcType=CLOB},
    			#{fexcelName,jdbcType=VARCHAR},
    			#{fgetType,jdbcType=INTEGER},
    			#{fuseStartTime,jdbcType=TIMESTAMP},
    			#{fuseEndTime,jdbcType=TIMESTAMP},
    			#{fuseTime,jdbcType=INTEGER},
    			#{fdollars,jdbcType=DECIMAL},
    			#{fcarSpecId,jdbcType=VARCHAR},
    			#{farea,jdbcType=VARCHAR},
    			#{createTime,jdbcType=TIMESTAMP},
    			#{creator,jdbcType=INTEGER},
    			#{operateTime,jdbcType=TIMESTAMP},
    			#{operator,jdbcType=INTEGER}
    		)
    	</insert>
    	
    	<update id="update">
    		update cl_couponsActivity set
    			fbusiness_type = #{fbusinessType,jdbcType=VARCHAR},
    			fcoupons_id = #{fcouponsId,jdbcType=INTEGER},
    			feffective = #{feffective,jdbcType=INTEGER},
    			factivity_start_time = #{factivityStartTime,jdbcType=TIMESTAMP},
    			factivity_end_time = #{factivityEndTime,jdbcType=TIMESTAMP},
    			fissue_user = #{fissueUser,jdbcType=CLOB},
    			fexcel_name = #{fexcelName,jdbcType=VARCHAR},
    			fget_type = #{fgetType,jdbcType=INTEGER},
    			fuse_start_time = #{fuseStartTime,jdbcType=TIMESTAMP},
    			fuse_end_time = #{fuseEndTime,jdbcType=TIMESTAMP},
    			fuse_time = #{fuseTime,jdbcType=INTEGER},
    			fdollars = #{fdollars,jdbcType=DECIMAL},
    			fcar_spec_id = #{fcarSpecId,jdbcType=VARCHAR},
    			farea = #{farea,jdbcType=VARCHAR},
    			create_time = #{createTime,jdbcType=TIMESTAMP},
    			creator = #{creator,jdbcType=INTEGER},
    			operate_time = #{operateTime,jdbcType=TIMESTAMP},
    			operator = #{operator,jdbcType=INTEGER}
    		where
    			fid = #{fid}
    	</update>
    	
    	<select id="getById" resultMap="CL_CouponsActivityMap">
    		select <include refid="columns"/> from cl_couponsActivity ca 
    		left join cl_coupons cc on cc.id = ca.fcoupons_id
    		where ca.fid = #{fid}
    	</select>
    	
    	<select id="getBeOverdueCouponsActivity" resultType="int">
    		select ca.fid from  cl_couponsActivity ca
					WHERE  ca.feffective=1 and DATE_FORMAT(ca.factivity_end_time ,'%Y-%m-%d') &lt; DATE_FORMAT(now(),'%Y-%m-%d')
    	</select>
    	
    	<update id="updateCoupons">
     	   update cl_couponsActivity  set feffective =3 WHERE fid IN 
			<foreach item="item" collection="array" open="("
				separator="," close=")">
				#{item}
			</foreach>
  	  </update>
    	
    	<sql id="findWhere">
    		<where>
    			<if test="@Ognl@isNotEmpty(feffective)">
    				and ca.feffective = #{feffective}
    			</if>
    			<if test="@Ognl@isNotEmpty(fissueUser)">
    				and ca.fissue_user like concat('%',#{fissueUser},'%')
    			</if>
    			 <if test="@Ognl@isNotEmpty(ids)">
   		     		and ca.fid in <foreach item="item" collection="ids" open="(" separator="," close=")">
					#{item}
				</foreach>
   			</if>
    		</where>
    		
    	</sql>
    	
    	<select id="find" resultMap="CL_CouponsActivityMap">
    		select <include refid="columns"/> from cl_couponsActivity ca
    		left join cl_coupons cc on cc.id = ca.fcoupons_id
    		<include refid="findWhere"/>
    	</select>
    	
    	<select id="findPage" resultMap="CL_CouponsActivityMap">
    		select <include refid="columns"/> from cl_couponsActivity ca
    		left join cl_coupons cc on cc.id = ca.fcoupons_id
    		<include refid="findWhere"/>
    		order by ca.operate_time desc
    	</select>
    	
    	<select id="findPageCount" resultType="long">
    		select count(ca.fid) from cl_couponsActivity ca
    		left join cl_coupons cc on cc.id = ca.fcoupons_id
    		<include refid="findWhere"/>
    	</select>
    	
    	<select id="singleFindPage" resultMap="CL_CouponsActivityMap">
    		select <include refid="columns"/> from cl_couponsActivity ca
    			left join cl_coupons cc on cc.id = ca.fcoupons_id
    			left join cl_coupons_detail cd on cd.coupons_activity_id = ca.fid
    		where 
    			ca.fid not in(select coupons_activity_id from cl_coupons_detail where creator = #{creator})
    			and ca.fissue_user like concat('%',#{fissueUser},'%')
    			and date_format(ca.factivity_start_time ,'%Y-%m-%d %H:%i') &lt; DATE_FORMAT(now(),'%Y-%m-%d %H:%i')
    			and date_format(ca.factivity_end_time ,'%Y-%m-%d %H:%i') > DATE_FORMAT(now(),'%Y-%m-%d %H:%i')
    			and ca.feffective = 1
    		order by create_time desc
    	</select>
    	
    	<select id="singleFindPageCount" resultType="long">
    		select count(ca.fid) from cl_couponsActivity ca
    			left join cl_coupons cc on cc.id = ca.fcoupons_id
    			left join cl_coupons_detail cd on cd.coupons_activity_id = ca.fid
    		where 
    			ca.fid not in(select coupons_activity_id from cl_coupons_detail where creator = #{creator})
    			and ca.fissue_user like concat('%',#{fissueUser},'%')
    			and date_format(ca.factivity_start_time ,'%Y-%m-%d %H:%i') &lt; DATE_FORMAT(now(),'%Y-%m-%d %H:%i')
    			and date_format(ca.factivity_end_time ,'%Y-%m-%d %H:%i') > DATE_FORMAT(now(),'%Y-%m-%d %H:%i')
    			and ca.feffective = 1
    	</select>
    	
    	
    </mapper>