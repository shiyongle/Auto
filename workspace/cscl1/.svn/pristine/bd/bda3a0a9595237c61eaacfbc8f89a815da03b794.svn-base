<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CL_CouponsDetail">

    <resultMap id="CL_CouponsDetailMap" type="com.pc.model.CL_CouponsDetail">
        <result property="id" column="id"/>
        <result property="couponsId" column="coupons_id"/>
        <result property="couponsActivityId" column="coupons_activity_id"/>
        <result property="isUse" column="is_use"/>
        <result property="isOverdue" column="is_overdue"/>
        <result property="creator" column="creator"/>
        <result property="createTime" column="create_time"/>
        <result property="startTime" column="fstart_time"/>
        <result property="endTime" column="fend_time"/>
        <result property="dollars" column="dollars"/>
        <result property="fcarSpecId" column="fcarSpec_id"/>
        <result property="farea" column="farea"/>
        <result property="ftype" column="ftype"/>
        <result property="fdiscount" column="fdiscount"/>
        <result property="fsubtract" column="fsubtract"/>
        <result property="faddserviceName" column="faddservice_name"/>
    </resultMap>

	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
	    <![CDATA[
        detail.id ,detail.coupons_id,detail.coupons_activity_id ,detail.is_use ,detail.is_overdue,detail.creator ,detail.create_time ,detail.fstart_time startTime,detail.fend_time endTime,detail.dollars,detail.ftype,detail.fdiscount,detail.fsubtract,detail.faddservice_name,
        detail.fcarSpec_id,detail.farea
	    ]]>
	</sql>
	
    <insert id="insert" >
    <![CDATA[
        INSERT INTO cl_coupons_detail (
	        id  ,
	        coupons_id  ,
	        coupons_activity_id  ,
	        is_use  ,
	        is_overdue ,
	        creator  ,
	        create_time  ,
	        fstart_time  ,
	        fend_time	,
	        dollars ,
	        fcarSpec_id ,
	        farea ,
	        ftype ,
	        fdiscount ,
	        fsubtract ,
	        faddservice_name
        ) VALUES (
        	#{id, jdbcType=INTEGER} ,
        	#{couponsId, jdbcType=INTEGER} ,
        	#{couponsActivityId, jdbcType=INTEGER} ,
        	#{isUse, jdbcType=INTEGER} ,
        	#{isOverdue, jdbcType=INTEGER} ,
        	#{creator, jdbcType=INTEGER} ,
        	#{createTime, jdbcType=TIMESTAMP} ,
        	#{startTime, jdbcType=TIMESTAMP} ,
        	#{endTime, jdbcType=TIMESTAMP} ,
        	#{dollars, jdbcType=DECIMAL} ,
        	#{fcarSpecId, jdbcType=VARCHAR} ,
        	#{farea, jdbcType=VARCHAR} ,
        	#{ftype, jdbcType=INTEGER} ,
        	#{fdiscount, jdbcType=DECIMAL} ,
        	#{fsubtract, jdbcType=DECIMAL} ,
        	#{faddserviceName, jdbcType=VARCHAR}
        )
    ]]>
    </insert>

    <update id="update" >
    <![CDATA[
        UPDATE cl_coupons_detail SET
	        coupons_id = #{couponsId, jdbcType=INTEGER} ,
	        coupons_activity_id = #{couponsActivityId, jdbcType=INTEGER} ,
	        is_use = #{isUse, jdbcType=INTEGER} ,
	        is_overdue = #{isOverdue, jdbcType=INTEGER} ,
	        creator = #{creator, jdbcType=INTEGER} ,
	        create_time = #{createTime, jdbcType=TIMESTAMP} ,
	        fstart_time = #{startTime, jdbcType=TIMESTAMP} ,
	        fend_time = #{endTime, jdbcType=TIMESTAMP} ,
	        dollars  = #{dollars, jdbcType=DECIMAL} ,
	        fcarSpec_id  = #{fcarSpecId, jdbcType=VARCHAR} ,
	        farea  = #{farea, jdbcType=VARCHAR} ,
            ftype = #{ftype, jdbcType=INTEGER} ,
        	fdiscount = #{fdiscount, jdbcType=DECIMAL} ,
        	fsubtract = #{fsubtract, jdbcType=DECIMAL} ,
        	faddservice_name = #{faddserviceName, jdbcType=VARCHAR}
        WHERE 
	        id = #{id} 
    ]]>
    </update>
    
    <!-- 将领取的优惠券更新为过期 -->
    <update id="updateCouponsDetail">
        update cl_coupons_detail  set is_overdue =1 WHERE
        id IN 
		<foreach item="item" collection="array" open="("
				separator="," close=")">
				#{item}
		</foreach>
    </update>

    <delete id="delete">
    <![CDATA[
        DELETE FROM cl_coupons_detail WHERE
        id = #{id} 
    ]]>
    </delete>
    
    <select id="getById" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/>
	    <![CDATA[
	        FROM cl_coupons_detail detail
	        LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
	        WHERE 
		        detail.id = #{id} 
	    ]]>
    </select>
    
     <select id="getByUserRoleId" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/>
	    <![CDATA[
	        FROM cl_coupons_detail detail
	        LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
	        WHERE 
		        detail.user_role_id=#{userRoleId} and detail.is_use=#{isUse}
	    ]]>
    </select>
    
     <select id="IsExistByUserRoleId" resultMap="CL_CouponsDetailMap">
     	SELECT id 
	    <![CDATA[
	        FROM cl_coupons_detail WHERE coupons_id in (7,8,9) and user_role_id=#{userRoleId} 
	    ]]>
    </select>
    
    <select id="getByCouponsId" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/>
	    <![CDATA[
	        FROM cl_coupons_detail detail
	        LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
	        WHERE detail.coupons_id = #{couponsId}  AND  cps.type in (2,1)
	    ]]>
    </select>
    
    <select id="getByCouponsId2" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/>
	    <![CDATA[
	        FROM cl_coupons_detail detail
	        LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
	        WHERE detail.coupons_id = #{couponsId}
	    ]]>
    </select>
    
    <select id="getBeOverdueCouponsDetail" resultType="int">
    	select detail.id from  cl_coupons_detail detail
					WHERE  detail.is_overdue=0 AND DATE_FORMAT(detail.fend_time ,'%Y-%m-%d') &lt; DATE_FORMAT(now(),'%Y-%m-%d')
	</select>
    

	<sql id="findWhere">
	    <where>
		   	<if test="@Ognl@isNotEmpty(id)">
			    AND detail.id = #{id}
			</if>
		   	<if test="@Ognl@isNotEmpty(couponsId)">
			    AND detail.coupons_id = #{couponsId}
			</if>
		   	<if test="@Ognl@isNotEmpty(isUse)">
			    AND detail.is_use = #{isUse}
			</if>
			<if test="@Ognl@isNotEmpty(isOverdue)">
			    AND detail.is_overdue = #{isOverdue}
			</if>
		   	<if test="@Ognl@isNotEmpty(creator)">
			    AND detail.creator = #{creator}
			</if>
		   	<if test="@Ognl@isNotEmpty(ftype)">
			    AND detail.ftype = #{ftype}
			</if>
		   	<if test="@Ognl@isNotEmpty(faddserviceName)">
			    AND detail.faddservice_name = #{faddserviceName}
			</if>
		   	<if test="@Ognl@isNotEmpty(farea)">
			    AND detail.farea like concat('%',#{farea},'%')
			</if>
		   	<if test="@Ognl@isNotEmpty(fcarSpecId)">
			    AND detail.fcarSpec_id like concat('%',#{fcarSpecId},'%')
			</if>
	    </where>
	</sql>
	 
    <select id="findPageCount" resultType="long">
        SELECT count(*) FROM cl_coupons_detail detail
        LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
        <include refid="findWhere"/>    
    </select>
    
    <!--
    	分页查询已经使用Dialect进行分页,也可以不使用Dialect直接编写分页
    	因为分页查询将传 #offset#,#pageSize#,#lastRows# 三个参数,不同的数据库可以根于此三个参数属性应用不同的分页实现
    -->
    <select id="findPage" resultMap="CL_CouponsDetailMap">
    	SELECT <include refid="columns"/> FROM cl_coupons_detail detail
    	LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
		<include refid="findWhere"/>
		ORDER BY detail.is_use asc , detail.is_overdue asc,detail.create_time desc
    </select>

	
	<select id="find" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/> FROM cl_coupons_detail detail
	    LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
		<include refid="findWhere"/>
		<if test="@Ognl@isNotEmpty(sortColumns)">
			ORDER BY detail.create_time ASC
		</if>
    </select>
	
	<select id="getCountByUserCoupon" resultType="int">
		SELECT COUNT(1) FROM cl_coupons_detail WHERE coupons_activity_id = #{couponsActivityId} AND creator = #{userId}
    </select>
    
    <select id="getEffective" resultMap="CL_CouponsDetailMap">
	    SELECT <include refid="columns"/> 
	    FROM cl_coupons_detail detail LEFT JOIN cl_coupons cps on cps.id = detail.coupons_id
		where  detail.is_use = #{is_use} and detail.is_overdue= #{is_overdue} and detail.creator = #{creator} and detail.ftype = #{ftype}  and detail.farea like concat('%',#{farea},'%')  and detail.fcarSpec_id like concat('%',#{fcarSpecId},'%')
    </select>
    
</mapper>

