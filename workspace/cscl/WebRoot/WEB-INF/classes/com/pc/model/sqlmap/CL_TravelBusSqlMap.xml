<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CL_TravelBus">

    <resultMap id="CLTravelBus" type="com.pc.model.CL_TravelBus">
		<result property="id" column="id"/>
        <result property="fbizDate" column="fbizDate"/>
        <result property="fbizManager" column="fbizManager"/>
        <result property="fpickupSite" column="fpickupSite"/>
        <result property="famount" column="famount"/>
        <result property="fkilo" column="fkilo"/>
        <result property="fdeliverySite" column="fdeliverySite"/>
        <result property="freceiptAddress" column="freceiptAddress"/>
        <result property="fbusPlate" column="fbusPlate"/>
        <result property="ftransferPlate" column="ftransferPlate"/>
        <result property="fallCost" column="fallCost"/>
        <result property="fdeliverySiteCost" column="fdeliverySiteCost"/>
        <result property="fbusCost" column="fbusCost"/>
        <result property="ftransferCost" column="ftransferCost"/>
        <result property="fsendCost" column="fsendCost"/>
        <result property="fcollectionDelivery" column="fcollectionDelivery"/>
        <result property="fFreightPaymentParty" column="fFreightPaymentParty"/>
        <result property="fFreightSettlement" column="fFreightSettlement"/>
        <result property="fnumber" column="fnumber"/>
        <result property="fcreator" column="fcreator"/>
        <result property="fcreateTime" column="fcreateTime"/>
        <result property="fremark" column="fremark"/>
    </resultMap>
   
	<!-- 用于select查询公用抽取的列 -->
	<sql id="columns">
	    <![CDATA[
	      tb.id,tb.fbizDate,tb.fbizManager,tb.fpickupSite,tb.famount,tb.fkilo,tb.fdeliverySite,tb.freceiptAddress,tb.fbusPlate,tb.ftransferPlate,tb.fallCost,tb.fdeliverySiteCost,
		  tb.fbusCost,tb.ftransferCost,tb.fsendCost,tb.fcollectionDelivery,tb.fFreightPaymentParty,tb.fFreightSettlement,tb.fnumber,tb.fcreator,tb.fcreateTime,tb.fremark,
		  clu.vmi_user_name as userName,clu.vmi_user_phone as userPhone
           ]]>
	</sql>
	
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    <![CDATA[
        INSERT INTO CL_TravelBus (
	      id,
	      fbizDate,
	      fbizManager,
	      fpickupSite,
	      famount,
	      fkilo,
	      fdeliverySite,
	      freceiptAddress,
	      fbusPlate,
	      ftransferPlate,
	      fallCost,
	      fdeliverySiteCost,
	      fbusCost,
	      ftransferCost,
	      fsendCost,
	      fcollectionDelivery,
	      fFreightPaymentParty,
	      fFreightSettlement,
	      fnumber,
	      fcreator,
	      fcreateTime,
	      fremark
        ) VALUES (
        	#{id, jdbcType=INTEGER} ,
        	#{fbizDate, jdbcType=TIMESTAMP} ,
        	#{fbizManager, jdbcType=VARCHAR} ,
        	#{fpickupSite, jdbcType=VARCHAR} ,
        	#{famount,jdbcType=DECIMAL},
        	#{fkilo,jdbcType=DECIMAL},
        	#{fdeliverySite, jdbcType=VARCHAR} ,
        	#{freceiptAddress, jdbcType=VARCHAR} ,
        	#{fbusPlate, jdbcType=VARCHAR} ,
        	#{ftransferPlate, jdbcType=VARCHAR} ,
        	#{fallCost,jdbcType=DECIMAL},
        	#{fdeliverySiteCost,jdbcType=DECIMAL},
        	#{fbusCost,jdbcType=DECIMAL},
        	#{ftransferCost,jdbcType=DECIMAL},
        	#{fsendCost,jdbcType=DECIMAL},
        	#{fcollectionDelivery,jdbcType=DECIMAL},
        	#{fFreightPaymentParty, jdbcType=VARCHAR} ,
        	#{fFreightSettlement, jdbcType=VARCHAR} ,
        	#{fnumber, jdbcType=VARCHAR} ,
        	#{fcreator, jdbcType=INTEGER} ,
        	#{fcreateTime, jdbcType=TIMESTAMP} ,
        	#{fremark, jdbcType=VARCHAR} 
        )
    ]]>
    </insert>

    <update id="update" >
    <![CDATA[
        UPDATE CL_TravelBus SET
        	fbizDate = #{fbizDate, jdbcType=TIMESTAMP} ,
        	fbizManager = #{fbizManager, jdbcType=VARCHAR} ,
        	fpickupSite = #{fpickupSite, jdbcType=VARCHAR} ,
        	famount = #{famount,jdbcType=DECIMAL},
        	fkilo = #{fkilo,jdbcType=DECIMAL},
        	fdeliverySite = #{fdeliverySite, jdbcType=VARCHAR} ,
        	freceiptAddress = #{freceiptAddress, jdbcType=VARCHAR} ,
        	fbusPlate = #{fbusPlate, jdbcType=VARCHAR} ,
        	ftransferPlate = #{ftransferPlate, jdbcType=VARCHAR} ,
        	fallCost = #{fallCost,jdbcType=DECIMAL},
        	fdeliverySiteCost = #{fdeliverySiteCost,jdbcType=DECIMAL},
        	fbusCost = #{fbusCost,jdbcType=DECIMAL},
        	ftransferCost = #{ftransferCost,jdbcType=DECIMAL},
        	fsendCost = #{fsendCost,jdbcType=DECIMAL},
        	fcollectionDelivery = #{fcollectionDelivery,jdbcType=DECIMAL},
        	fFreightPaymentParty = #{fFreightPaymentParty, jdbcType=VARCHAR} ,
        	fFreightSettlement = #{fFreightSettlement, jdbcType=VARCHAR} ,
        	fnumber = #{fnumber, jdbcType=VARCHAR} ,
        	fremark = #{fremark, jdbcType=VARCHAR} 
        
        WHERE 
	        id = #{id} 
    ]]>
    </update>
    
    <delete id="delete">
    <![CDATA[
        DELETE FROM CL_TravelBus WHERE id = #{id} 
    ]]>
    </delete>
    
    <delete id="deleteByIdAndUser">
    <![CDATA[
        DELETE FROM CL_TravelBus WHERE id = #{id} and fcreator = #{userroleId} 
    ]]>
    </delete>
       
   <select id="getById" resultMap="CLTravelBus">
       SELECT <include refid="columns"/>  FROM CL_TravelBus tb
    	 LEFT JOIN cl_user_role clu on clu.id=tb.fcreator 
    	 where tb.id=#{id}
   </select>
   
   <select id="getByUserId" resultMap="CLTravelBus">
       SELECT <include refid="columns"/>  FROM CL_TravelBus tb
    	 LEFT JOIN cl_user_role clu on clu.id=tb.fcreator 
    	 where tb.fcreator=#{userRoleId} 
   </select>
     
	<sql id="findWhere">
	    <where>
	        <if test="@Ognl@isNotEmpty(famount)">
			    AND  tb.famount = #{famount}
		    </if>
		   	
		   	<if test="@Ognl@isNotEmpty(fbizDateBegin)">
		   		AND DATE_FORMAT(tb.fbizDate ,'%Y-%m-%d %H') >= DATE_FORMAT(#{fbizDateBegin},'%Y-%m-%d %H')
		   	</if>
		   	<if test="@Ognl@isNotEmpty(fbizDateEnd)">
		   		AND DATE_FORMAT(tb.fbizDate ,'%Y-%m-%d %H') &lt; DATE_FORMAT(#{fbizDateEnd},'%Y-%m-%d %H')
		   	</if>
		   	
		   	<if test="@Ognl@isNotEmpty(fcreateTimeBegin)">
		   		AND DATE_FORMAT(tb.fcreateTime ,'%Y-%m-%d %H') >= DATE_FORMAT(#{fcreateTimeBegin},'%Y-%m-%d %H')
		   	</if>
		   	<if test="@Ognl@isNotEmpty(fcreateTimeEnd)">
		   		AND DATE_FORMAT(tb.fcreateTime ,'%Y-%m-%d %H') &lt; DATE_FORMAT(#{fcreateTimeEnd},'%Y-%m-%d %H')
		   	</if>
		    
           <if test="@Ognl@isNotEmpty(fbizManager)">
		       AND (
		          tb.fbizManager LIKE CONCAT('%',#{fbizManager},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(fpickupSite)">
		       AND (
		          tb.fpickupSite LIKE CONCAT('%',#{fpickupSite},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(fdeliverySite)">
		       AND (
		          tb.fdeliverySite LIKE CONCAT('%',#{fdeliverySite},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(freceiptAddress)">
		       AND (
		          tb.freceiptAddress LIKE CONCAT('%',#{freceiptAddress},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(fbusPlate)">
		       AND (
		          tb.fbusPlate LIKE CONCAT('%',#{fbusPlate},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(ftransferPlate)">
		       AND (
		          tb.ftransferPlate LIKE CONCAT('%',#{ftransferPlate},'%') 
		      )
		   </if>
		    
           <if test="@Ognl@isNotEmpty(searchKey)">
		       AND (
		          clu.vmi_user_name LIKE CONCAT('%',#{searchKey},'%') 
		      )
		   </if>
	    </where>
	</sql>
	 
    <select id="findPageCount" resultType="long">
        SELECT count(*) FROM CL_TravelBus tb
    	 LEFT JOIN cl_user_role clu on clu.id=tb.fcreator
		<include refid="findWhere"/>    
    </select>
    
    
    <!--
    	分页查询已经使用Dialect进行分页,也可以不使用Dialect直接编写分页
    	因为分页查询将传 #offset#,#pageSize#,#lastRows# 三个参数,不同的数据库可以根于此三个参数属性应用不同的分页实现
    -->
    <select id="findPage" resultMap="CLTravelBus">
    	SELECT <include refid="columns"/> 
    	FROM CL_TravelBus tb
    	 LEFT JOIN cl_user_role clu on clu.id=tb.fcreator 
		<include refid="findWhere"/> 
		ORDER BY clu.vmi_user_name DESC
    </select>
    
   
	
	<select id="find" resultMap="CLTravelBus">
	    SELECT <include refid="columns"/> 
	    FROM CL_TravelBus tb
    	 LEFT JOIN cl_user_role clu on clu.id=tb.fcreator 
		<include refid="findWhere"/>
		<if test="@Ognl@isNotEmpty(sortColumns)">
			ORDER BY ${sortColumns}
		</if>
    </select>

</mapper>

