<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    <mapper namespace="CL_Distance">
    <resultMap type="com.pc.model.CL_Distance" id="CLDistanceMap">
    	<result property="fid" column="fid"/>
    	<result property="fcustomer_id" column="fcustomer_id"/>
    	<result property="faddressDel" column="faddressDel"/>
    	<result property="faddressRec" column="faddressRec"/>
   		<result property="faddressDel_id" column="faddressDel_id"/>
    	<result property="faddressRec_id" column="faddressRec_id"/> 
    	<result property="fmileage" column="fmileage"/>
    	<result property="fcreate_time" column="fcreate_time"/>
    	<result property="fcreater_id" column="fcreater_id"/>
    	<result property="fedit_time" column="fedit_time"/>
    	<result property="feditor_id" column="feditor_id"/>
    	<result property="fcustomer" column="fcustomer"/>
    </resultMap>
    
<!--  select查询公用抽取列 -->
    <sql id="columns">
    	 <![CDATA[	
    	 distance.fid ,distance.fcustomer_id ,distance.faddressDel,distance. faddressRec,distance.fmileage,distance.fcreate_time,distance.fcreater_id ,distance.fedit_time,distance.feditor_id,distance.fcustomer,
    	 distance.faddressDel_id,distance.faddressRec_id,
    	user1.vmi_user_name as fcreater,user2.vmi_user_name as feditor
    	 ]]>
    </sql>
    <!--  user.vmi_user_name as fcustomer, -->
    
    <insert id="insert" useGeneratedKeys="true"  keyProperty="fid">
    	<![CDATA[
    	insert into cl_distance(
	    	fcustomer_id,
	    	fcustomer,
	    	faddressDel,
	    	faddressRec,
	    	fmileage,
	    	fcreate_time,
	    	fcreater_id,
	    	fedit_time,
	    	feditor_id,
	    	faddressDel_id,
	    	faddressRec_id
    	) values(
    		#{fcustomer_id,jdbcType=INTEGER},
    		#{fcustomer,jdbcType=VARCHAR},
    		#{faddressDel,jdbcType=VARCHAR},
    		#{faddressRec,jdbcType=VARCHAR},
    		#{fmileage,jdbcType=DECIMAL},
    		#{fcreate_time,jdbcType=TIMESTAMP},
    		#{fcreater_id,jdbcType=INTEGER},
    		#{fedit_time,jdbcType=TIMESTAMP},
    		#{feditor_id,jdbcType=INTEGER},
    		#{faddressDel_id,jdbcType=INTEGER},
    		#{faddressRec_id,jdbcType=INTEGER}
    	)
    	]]>
    </insert>
    
    <delete id="delete">
    	  <![CDATA[
     	  delete from cl_distance where
    	    fid = #{fid} 
  		  ]]>
    </delete>
    
    <update id="update">
    <![CDATA[
    update cl_distance set
	    fcustomer_id = #{fcustomer_id,jdbcType=INTEGER},
	    fcustomer = #{fcustomer,jdbcType=VARCHAR},
	    faddressDel = #{faddressDel,jdbcType=VARCHAR},
	    faddressRec = #{faddressRec,jdbcType=VARCHAR},
	    fmileage = #{fmileage,jdbcType=DECIMAL},
	    fcreate_time = #{fcreate_time,jdbcType=TIMESTAMP},
	    fcreater_id = #{fcreater_id,jdbcType=INTEGER},
	    fedit_time = #{fedit_time,jdbcType=TIMESTAMP},
	    feditor_id = #{feditor_id,jdbcType=INTEGER} ,
	    faddressDel_id = #{faddressDel_id,jdbcType=INTEGER} ,
	    faddressRec_id = #{faddressRec_id,jdbcType=INTEGER} 
	 where 
	    fid = #{fid,jdbcType=INTEGER}	
    ]]>
    </update>
    
    <select id="getById" resultMap="CLDistanceMap">
    	select * from cl_distance where fid = #{fid}
    </select>
    
    <!-- 需求只有一个客户名模糊查询，需要改动了再加 -->
    <sql id="findWhere">
	    <where>
			<if test="@Ognl@isNotEmpty(fcustomer)">
	   			and fcustomer like concat ( '%',#{fcustomer},'%')
	   		</if>
	    </where>
	</sql>
    
     <select id="findPageCount" resultType="long">
        SELECT count(fid) FROM cl_distance 
        <include refid="findWhere"/>    
    </select>
    
    <select id="findPage" resultMap="CLDistanceMap">
    	SELECT <include refid="columns"/> FROM  cl_distance distance
    	left join cl_user_role user on user.id = distance.fcustomer_id
    	left join cl_user_role user1 on user1.id = distance.fcreater_id
    	left join cl_user_role user2 on user2.id = distance.feditor_id
		<include refid="findWhere"/>
		ORDER BY fedit_time DESC 
    </select>
    
    <select id="getMileage" resultType="decimal">
    	select fmileage from cl_distance where fcustomer_id = #{fcustomer_id} and faddressDel_id = #{faddressDel_id} and faddressRec_id = #{faddressRec_id} limit 1 
    </select>
    
    <!-- 同一个客户，相同的路线只能创建一次 -->
    <select id="isExist" resultType="int">
    	select count(fid) from cl_distance where fcustomer_id = #{fcustomer_id} and faddressDel_id = #{faddressDel_id} and faddressRec_id = #{faddressRec_id}
    </select>
    
    
    
    </mapper>